<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AINZUNI - Your guide to New Zealand Universities">
  <meta name="author" content="Rishikesh">
  <title>AINZUNI - NZ Universities</title>
</head>

<body>
  <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn" aria-label="Toggle theme">🌙</button>

  <button class="menu-btn" onclick="toggleMenu()" aria-label="Open menu">
    <img src="images/AINZUNI2.png" alt="AINZUNI Logo" class="logo">
  </button>

  <div class="menu" id="menu">
    <button onclick="location.href='Website Digitech.html'">🏠 Home</button>
    <button onclick="location.href='About Me.html'">👤 About</button>
    <button onclick="location.href='NZ Universities.html'">🎓 NZ Universities</button>
    <button onclick="location.href='Contact Me.html'">📧 Contact</button>
  </div>

  <!-- ...rest of code unchanged... -->

  <script>
    // Always set API URL before use
    if (!localStorage.getItem('chat_api_url')) {
      localStorage.setItem('chat_api_url', 'http://127.0.0.1:8000/api/chat');
    }
    const CHAT_API_URL = localStorage.getItem('chat_api_url');

    // THEME TOGGLE
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const themeBtn = document.getElementById('theme-btn');
      if (document.body.classList.contains('dark-mode')) {
        themeBtn.textContent = '☀️';
        localStorage.setItem('theme', 'dark');
      } else {
        themeBtn.textContent = '🌙';
        localStorage.setItem('theme', 'light');
      }
    }

    // LOAD SAVED THEME
    document.addEventListener('DOMContentLoaded', function () {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-btn').textContent = '☀️';
      }

      appendMessage('bot', 'Kia Ora! I\'m AINZUNI, your AI guide to New Zealand Universities. How can I help you start your study journey?');
      document.getElementById('chat-input').addEventListener('keydown', e => { if (e.key === 'Enter') sendMessage(); });
    });

    // MENU TOGGLE (class version)
    function toggleMenu() {
      document.getElementById('menu').classList.toggle('active');
    }

    document.addEventListener('click', function (event) {
      const menu = document.getElementById('menu');
      const menuBtn = document.querySelector('.menu-btn');
      if (menu.classList.contains('active') && !menuBtn.contains(event.target) && !menu.contains(event.target)) {
        menu.classList.remove('active');
      }
    });

    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const sendBtn = input.nextElementSibling;
      const message = input.value.trim();
      if (!message) return;

      appendMessage('user', message);
      input.value = '';
      input.disabled = true;
      sendBtn.disabled = true;

      const { wrapper: botWrapper, content: botContent } = appendMessage('bot', 'AINZUNI is thinking', 'typing');
      try {
        const res = await fetch(CHAT_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: 'phi4-14b', input: message })
        });

        botWrapper.classList.remove('typing');
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Server error ${res.status}: ${text.substring(0, 100)}...`);
        }

        let data;
        try { data = await res.json(); }
        catch { const text = await res.text(); throw new Error(`Invalid JSON response: ${text}`); }

        const reply = data.reply || data.output || data.text || JSON.stringify(data);
        botContent.textContent = reply;

      } catch (err) {
        botWrapper.classList.remove('typing');
        botContent.textContent = `🚨 Connection Error: The chatbot server at ${CHAT_API_URL} could not be reached. Check console.`;
        console.error(err);
      } finally {
        input.disabled = false;
        sendBtn.disabled = false;
        input.focus();
      }
    }
  </script>
</body>
</html>
